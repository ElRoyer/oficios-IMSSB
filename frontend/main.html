<html
  class="js svg wf-opensans-i3-active wf-opensans-i4-active wf-opensans-n3-active wf-opensans-n4-active wf-opensans-n6-active wf-opensans-n7-active wf-active"
  lang="es"
>
  <head>
    <title>
      Centro Nacional para la Prevención y Control del VIH y el sida
    </title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link
      href="https://framework-gb.cdn.gob.mx/favicon.ico"
      rel="shortcut icon"
    />
    <link
      href="https://framework-gb.cdn.gob.mx/assets/styles/main.css"
      rel="stylesheet"
    />
    <link href="https://www.gob.mx/cms/application.css" rel="stylesheet" />
    <script
      src="https://framework-gb.cdn.gob.mx/gobmx.js"
      type="text/javascript"
    ></script>
    <!--Script para verificar sí el usuario esta autenticado-->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const authUser = localStorage.getItem("authUser");
        if (!authUser) {
          alert(
            "No estás autenticado. Redirigiendo a la página de inicio de sesión..."
          );
          window.location.href = "index.html"; // Redirige a la página de login
        }
      });
    </script>
    <!--Link para poder utilizar font awesome-->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <link rel="stylesheet" href="styles_upload.css" />
    <!-- Agregar DataTables desde CDN -->

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
    />
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <link
      href="https://framework-gb.cdn.gob.mx/applications/cms/favicon.png"
      rel="shortcut icon"
    />
    <script
      src="https://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js"
      type="text/javascript"
      async=""
    ></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://framework-gb.cdn.gob.mx/assets/scripts/plugins.js"></script>
    <script async="" src="//www.google-analytics.com/analytics.js"></script>
    <script
      type="text/javascript"
      src="https://framework-gb.cdn.gob.mx/assets/scripts/vendor/modernizr.js"
    ></script>
    <script
      type="text/javascript"
      src="https://framework-gb.cdn.gob.mx/assets/scripts/vendor/pace.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://framework-gb.cdn.gob.mx/assets/scripts/vendor/analitycs.js"
    ></script>
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Anton&display=swap"
      rel="stylesheet"
    />
    <!-- Incluir jsPDF y autoTable desde CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <link rel="stylesheet" href="styles_upload.css" />
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-SQH6J87DQ2"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-SQH6J87DQ2");
    </script>
  </head>

  <body>
    <div
      class="pace-progress"
      data-progress-text="100%"
      data-progress="99"
      style="transform: translate3d(100%, 0px, 0px)"
    >
      <div class="pace-progress-inner"></div>
    </div>
    <div class="pace-activity"></div>

    <h1 class="sr-only">Sitio del Instituto</h1>
    <!-- BANNER -->
    <div
      class="flag-banner hidden-xs"
      style="background-image: url(img/avatar.jpg); margin-top: 80px"
    ></div>
    <!-- FIN BANNER -->

    <!--- MENÚ --->
    <div class="nav" role="navigation">
      <nav class="navbar navbar-inverse sub-navbar navbar-fixed-top">
        <div class="navbar-header" style="padding-left: 200px">
          <a class="navbar-brand" href="#">IMSS BIENESTAR</a>
        </div>
        <div
          class="collapse navbar-collapse"
          style="padding-right: 250px"
          id="subenlaces"
        >
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#modal2" class="active">AGREGAR OFICIO</a></li>
            <li>
              <a onclick="mostrarFiltro()" class="active">FILTRAR FECHA</a>
            </li>
            <li><a id="generarPDF" class="active">EXPORTAR PDF</a></li>
            <li><a id="exportarExcel" class="active">EXPORTAR EXCEL</a></li>
            <li><a id="logoutBtn" class="active cerrar">CERRAR SESIÓN</a></li>
          </ul>
        </div>
      </nav>
    </div>
    <!--- FIN MENÚ --->

    <div class="container">
      <h2>Oficios CUSeN</h2>
      <hr class="red" />
      <br />
      <br />

      <div class="header">
        <div class="search-container">
          <input
            class="buscar"
            type="text"
            id="folioSearch"
            placeholder="Buscar por Folio"
          />
          <button id="searchBtn" class="agregar">Buscar</button>
        </div>

        <div id="fechaFiltro" style="display: none">
          <label>Desde: <input type="date" id="fechaInicio" /></label>
          <label>Hasta: <input type="date" id="fechaFin" /></label>
          <button onclick="filtrarPorFecha()">Buscar</button>
          <span
            id="filtroActivo"
            style="
              display: none;
              color: #9a3f2f;
              font-size: 20px;
              cursor: pointer;
            "
            onclick="eliminarFiltro()"
            >❌</span
          >
        </div>
        <div id="resultados"></div>
      </div>

      <!-- Modal para mostrar los resultados -->
      <div id="modal" class="modal" style="display: none">
        <div class="modalcontent">
          <!-- Button 1-->
          <a class="btn btn-1" href="#" id="closeModal">
            <svg>
              <rect x="0" y="0" fill="none" width="100%" height="100%"></rect>
            </svg>
            cerrar busqueda</a
          >

          <h3>Resultado de la búsqueda</h3>
          <table id="modalTable">
            <thead>
              <tr>
                <th>Folio</th>
                <th>Asunto</th>
                <th>Destinatario</th>
                <th>Remitente</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Enlace</th>
                <th>Editar</th>
              </tr>
            </thead>
            <tbody id="modalBody">
              <!-- Aquí se insertarán los datos del oficio -->
            </tbody>
          </table>
        </div>
      </div>

      <!--Modal para regitrar nuevo oficio-->
      <div id="modal2" class="modalmask2">
        <div class="modalbox movedown">
          <a href="#close" title="Close" class="close">X</a>
          <!-- multistep form -->
          <form
            id="miFormulario"
            oninput="
                document.getElementById('folioOut').textContent = folio.value;
                document.getElementById('asuntoOut').textContent = asunto.value;
                document.getElementById('destinatarioOut').textContent = destinatario.value;
                document.getElementById('remitenteOut').textContent = remitente.value;
                document.getElementById('estadoOut').textContent = estado.value;
            "
          >
            <!-- progressbar -->
            <ul id="progressbar">
              <li class="active">Seleccionar archivo</li>
              <li>Registrar información</li>
              <li>Verificar datos</li>
            </ul>
            <!-- fieldsets -->
            <fieldset>
              <h2 class="fs-title">Seleccionar archivo</h2>
              <br />
              <input type="file" id="fileInput" accept=".jpg, .jpeg, .png, .pdf"/><br /><br />
              <span id="fileError" style="color: red;"></span>
              <input
                type="button"
                name="next"
                class="next action-button"
                value="Siguiente"
              />
            </fieldset>
            <fieldset>
              <h2 class="fs-title">Registrar información</h2>

              <input
                type="text"
                id="folio"
                name="folio"
                placeholder="Folio"
                required
              /><br /><br />

              <input
                type="text"
                id="asunto"
                name="asunto"
                placeholder="Asunto"
                required
              /><br /><br />

              <input
                type="text"
                id="destinatario"
                name="destinatario"
                placeholder="Destinatario"
                required
              /><br /><br />

              <input
                type="text"
                id="remitente"
                name="remitente"
                placeholder="Remitente"
                required
              /><br /><br />

              <input
                type="text"
                id="estado"
                name="estado"
                placeholder="Estado"
                required
              /><br /><br />
              <input
                type="button"
                name="previous"
                class="previous action-button"
                value="Regresar"
              />
              <input
                type="button"
                name="next"
                class="next action-button"
                value="Siguiente"
              />
            </fieldset>
            <fieldset>
              <h2 class="fs-title">Verificar información</h2>
              <p><b>Folio:</b> <output id="folioOut"></output></p>
              <p><b>Asunto:</b> <output id="asuntoOut"></output></p>
              <p><b>Destinatario:</b> <output id="destinatarioOut"></output></p>
              <p><b>Remitente:</b> <output id="remitenteOut"></output></p>
              <p><b>Estado:</b> <output id="estadoOut"></output></p>
              <input
                type="button"
                name="previous"
                class="previous action-button"
                value="Regresar"
              />
              <button
                href="#close"
                id="uploadButton"
                disabled
                class="submit action-button"
              >
                Subir
              </button>
            </fieldset>
          </form>
        </div>
      </div>

      <!-- Tabla centrada -->
      <div class="table-container">
        <!-- Listar tabla todos los oficios -->
        <table id="tablaOficios" border="1">
          <thead>
            <tr>
              <th>Folio</th>
              <th>Asunto</th>
              <th>Destinatario</th>
              <th>Remitente</th>
              <th>Estado</th>
              <th>Fecha</th>
              <th>Enlace</th>
              <th>Editar</th>
            </tr>
          </thead>
          <tbody id="tablaCuerpo">
            <!-- Aquí se insertarán los datos dinámicamente -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal para editar -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div id="modalEditar" class="modalEditar" style="display: none">
      <div class="modal-content-editar">
        <span class="close" onclick="cerrarModalEditar()">&times;</span>
        <h3>Modificar Oficio</h3>
        <input type="hidden" id="editId" />
        <label>Folio:</label><br />
        <input type="text" id="editFolio" /><br /><br />
        <label>Asunto:</label><br />
        <input type="text" id="editAsunto" /><br /><br />
        <label>Destinatario:</label><br />
        <input type="text" id="editDestinatario" /><br /><br />
        <label>Remitente:</label><br />
        <input type="text" id="editRemitente" /><br /><br />
        <label>Estado:</label><br />
        <input type="text" id="editEstado" /><br /><br />
        <button onclick="updateOficio()"></button>
        <!-- Button 1-->
        <a class="btn btn-1" onclick="updateOficio()" id="closeModal">
          <svg>
            <rect x="0" y="0" fill="none" width="100%" height="100%"></rect>
          </svg>
          Guardar Cambios</a
        >
      </div>
    </div>

    <!--Alerta Modificacion-->
    <div id="customAlert" class="alert">
      <span id="alertIcon">⚠️</span>
      <span id="alertMessage"></span> <br/>
      <button onclick="closeAlert()">OK</button>
    </div>


    <!--Modal para mostrar registros en la tabla-->
    <script>
      let lastVisible = null;
      const pageSize = 120;
      let canLoadNext = false;

      document.addEventListener("DOMContentLoaded", () => {
        fetchOficios();
      });

      async function fetchOficios(next = true) {
        try {
          let url = `https://oficios-imssb.onrender.com/oficios?pageSize=${pageSize}`;

          const response = await fetch(url);
          const data = await response.json();

          if (!data || !data.oficios || !Array.isArray(data.oficios)) {
            showAlert("Error no se recibieron datos válidos.", "error");
            return;
          }
          const oficios = data.oficios; // ✅ Extraer correctamente los datos
          lastVisible = data.lastVisible; // ✅ Guardar el último documento recibido

          // Verifica si hay más datos para cargar
          canLoadNext = data.lastVisible !== null;

          updateTable(oficios);
        } catch (error) {
          showAlert("Error al obtener los oficios.", "error");
        }
      }

      function updateTable(oficios) {
        const tabla = document.querySelector("#tablaCuerpo");
        tabla.innerHTML = ""; // ✅ Limpiar antes de agregar nuevos datos

        if (!oficios || oficios.length === 0) {
          tabla.innerHTML =
            "<tr><td colspan='7'>No hay oficios disponibles</td></tr>";
          return;
        }

        oficios.forEach((oficio) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${oficio.folio || "N/A"}</td>
            <td>${oficio.asunto || "N/A"}</td>
            <td>${oficio.destinatario || "N/A"}</td>
            <td>${oficio.remitente || "N/A"}</td>
            <td>${oficio.estado || "N/A"}</td>
            <td>${
              oficio.fecha ? new Date(oficio.fecha).toLocaleString() : "N/A"
            }</td>
            <td>
              <a href="${
                oficio.enlace || "#"
              }" target="_blank"><i class="fa-solid fa-eye"></i></a></td>
            <td>
              <button onclick='abrirModalEditar("${oficio.id}", "${
            oficio.folio || ""
          }", "${oficio.asunto || ""}", "${oficio.destinatario || ""}", "${
            oficio.remitente || ""
          }", "${oficio.estado || ""}")'><i class="fa-solid fa-pencil"></i>
          </button>
            </td>
        `;
          tabla.appendChild(row);
        });
      }
      document
        .getElementById("btnNext")
        .addEventListener("click", () => fetchOficios(true));
      document
        .getElementById("btnPrev")
        .addEventListener("click", () => fetchOficios(false));
    </script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

    <script src="./script_upload.js"></script>
  </body>
</html>
